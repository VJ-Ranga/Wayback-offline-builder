<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Settings - Wayback Offline Builder</title>
  <style>
    :root {
      --theme-accent: {{ settings.theme_accent }};
      --theme-accent-hover: {{ settings.theme_accent_2 }};
      --theme-success: {{ settings.theme_success }};
      --theme-bg: {{ settings.theme_bg }};
      --theme-card: {{ settings.theme_card }};
      --theme-text: {{ settings.theme_text }};
      --theme-muted: {{ settings.theme_muted }};
      --theme-border: {{ settings.theme_border }};
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--theme-bg);
      color: var(--theme-text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      padding: 20px 14px;
    }

    .container { max-width: 1060px; margin: 0 auto; }
    .header {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
    }
    .header h1 { margin: 0; font-size: 32px; line-height: 1; }
    .sub { margin: 8px 0 0; color: var(--theme-muted); }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
    }
    .btn-primary { background: var(--theme-accent); color: #fff; }
    .btn-primary:hover { background: var(--theme-accent-hover); }
    .btn-light { background: #fff; color: var(--theme-text); border-color: var(--theme-border); }
    .btn-danger { background: #fff1f1; color: #a03030; border-color: #f1cccc; }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      align-items: start;
    }
    .card {
      background: var(--theme-card);
      border: 1px solid var(--theme-border);
      border-radius: 12px;
      overflow: hidden;
    }
    .card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--theme-border);
      background: rgba(255,255,255,0.45);
      font-weight: 700;
    }
    .hint { color: var(--theme-muted); font-size: 12px; margin: 0 0 10px; }
    .card-body { padding: 16px; }

    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px 16px; }
    .field label { display: block; font-size: 12px; font-weight: 700; letter-spacing: .03em; margin: 0 0 6px; color: var(--theme-muted); }
    .input {
      width: 100%;
      border: 1px solid var(--theme-border);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      color: var(--theme-text);
      font-size: 14px;
    }
    .input:focus { outline: 2px solid var(--theme-accent); outline-offset: -1px; }

    .color-row {
      display: grid;
      grid-template-columns: 42px 1fr;
      gap: 8px;
      align-items: center;
    }
    .picker-wrap {
      width: 42px;
      height: 42px;
      border: 1px solid var(--theme-border);
      border-radius: 10px;
      padding: 4px;
      background: #fff;
      overflow: hidden;
    }
    .color-picker {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
    }
    .color-picker::-webkit-color-swatch-wrapper { padding: 0; }
    .color-picker::-webkit-color-swatch { border: none; border-radius: 6px; }
    .color-picker::-moz-color-swatch { border: none; border-radius: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; text-transform: uppercase; }

    .actions {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .actions .btn { width: 100%; }

    .pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .pill {
      border: 1px solid var(--theme-border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--theme-muted);
      background: #fff;
    }

    .ok {
      margin: 0 0 10px;
      border: 1px solid #cfe8d3;
      background: #edf9ef;
      color: #2f6b3b;
      border-radius: 10px;
      padding: 8px 10px;
    }
    .err {
      margin: 0 0 10px;
      border: 1px solid #f1c9c9;
      background: #fdecec;
      color: #8b2a2a;
      border-radius: 10px;
      padding: 8px 10px;
    }

    .preview-shell {
      position: sticky;
      top: 16px;
    }
    .preview-window {
      border: 1px solid var(--theme-border);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
      box-shadow: 0 4px 18px rgba(0,0,0,.08);
    }
    .preview-top {
      padding: 8px 10px;
      border-bottom: 1px solid var(--theme-border);
      background: #f9f8f6;
      color: #8a8074;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .preview-body {
      padding: 14px;
      background: var(--theme-bg);
    }
    .preview-card {
      border: 1px solid var(--theme-border);
      border-radius: 10px;
      background: var(--theme-card);
      padding: 12px;
    }
    .preview-title { margin: 0 0 4px; color: var(--theme-text); font-weight: 700; }
    .preview-sub { margin: 0 0 10px; color: var(--theme-muted); font-size: 12px; }
    .preview-btns { display: flex; gap: 8px; }
    .preview-btn {
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      border: 1px solid transparent;
    }
    .preview-btn.primary { background: var(--theme-accent); color: #fff; }
    .preview-btn.success { color: var(--theme-success); border-color: var(--theme-success); background: #fff; }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .preview-shell { position: static; }
    }
    @media (max-width: 760px) {
      .header { flex-direction: column; align-items: flex-start; }
      .header h1 { font-size: 30px; }
      .grid2 { grid-template-columns: 1fr; }
      .actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div>
        <h1>Settings</h1>
        <p class="sub">Configure your theme and engine defaults. Saved locally in SQLite.</p>
      </div>
      <a href="/" class="btn btn-light">Back to Tool</a>
    </header>

    <form method="post" action="/settings" class="layout">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

      <div>
        {% if saved %}<div class="ok">Settings saved.</div>{% endif %}
        {% if error %}<div class="err">{{ error }}</div>{% endif %}

        <section class="card">
          <div class="card-head">
            <span>Theme</span>
            <button class="btn btn-light" type="button" id="reset-colors-btn" style="padding:6px 10px;font-size:12px;">Restore default colors</button>
          </div>
          <div class="card-body grid2">
            <p class="hint" style="grid-column: 1 / -1;">Pick colors for the main app. Changes appear instantly in the preview.</p>
            {% set color_fields = [
              ('theme_accent', 'Accent Color'),
              ('theme_accent_2', 'Accent Hover'),
              ('theme_success', 'Success Color'),
              ('theme_bg', 'Page Background'),
              ('theme_card', 'Card Surface'),
              ('theme_text', 'Primary Text'),
              ('theme_muted', 'Muted Text'),
              ('theme_border', 'Border Color')
            ] %}
            {% for key, label in color_fields %}
            <div class="field" data-color-key="{{ key }}">
              <label>{{ label }}</label>
              <div class="color-row">
                <span class="picker-wrap"><input class="color-picker" type="color" value="{{ settings[key] }}"></span>
                <input class="input mono color-hex" type="text" name="{{ key }}" value="{{ settings[key] }}" pattern="^#[0-9a-fA-F]{6}$">
              </div>
            </div>
            {% endfor %}
          </div>
        </section>

        <section class="card" style="margin-top: 14px;">
          <div class="card-head">Defaults</div>
          <div class="card-body grid2">
            <p class="hint" style="grid-column: 1 / -1;">These values become the default inputs on the main workflow.</p>
            <div class="field"><label>Output Root</label><input class="input" type="text" name="default_output_root" value="{{ settings.default_output_root }}"></div>
            <div class="field"><label>Display Limit</label><input class="input" type="number" name="default_display_limit" min="5" max="2000" value="{{ settings.default_display_limit }}"></div>
            <div class="field"><label>CDX Inspect Limit</label><input class="input" type="number" name="default_inspect_cdx_limit" min="500" max="100000" value="{{ settings.default_inspect_cdx_limit }}"></div>
            <div class="field"><label>Analyze CDX Limit</label><input class="input" type="number" name="default_analyze_cdx_limit" min="500" max="100000" value="{{ settings.default_analyze_cdx_limit }}"></div>
            <div class="field"><label>Max Files Per Run</label><input class="input" type="number" name="default_max_files" min="50" max="5000" value="{{ settings.default_max_files }}"></div>
            <div class="field"><label>Missing File Limit</label><input class="input" type="number" name="default_missing_limit" min="1" max="5000" value="{{ settings.default_missing_limit }}"></div>
          </div>
        </section>

        <section class="card" style="margin-top: 14px;">
          <div class="card-head">Safety</div>
          <div class="card-body">
            <p class="hint">Project deletes can optionally remove local output files. Paths outside configured safe output root are skipped automatically.</p>
            <div class="pills">
              <span class="pill">CSRF-protected requests</span>
              <span class="pill">Localhost mutation guard</span>
              <span class="pill">Safe output-root checks</span>
            </div>
          </div>
        </section>

        <div class="actions">
          <button class="btn btn-primary" type="submit">Save Settings</button>
          <button class="btn btn-danger" type="submit" formaction="/settings/reset">Restore all defaults</button>
          <a class="btn btn-light" href="/">Back to Tool</a>
        </div>
      </div>

      <aside class="preview-shell">
        <div class="preview-window">
          <div class="preview-top">Live Theme Preview</div>
          <div class="preview-body" id="theme-preview-body">
            <div class="preview-card" id="theme-preview-card">
              <p class="preview-title" id="theme-preview-text">Project Summary</p>
              <p class="preview-sub" id="theme-preview-muted">Offline archive ready for download.</p>
              <div class="preview-btns">
                <span class="preview-btn primary" id="theme-preview-btn">Action Button</span>
                <span class="preview-btn success" id="theme-preview-success">Status: OK</span>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </form>
  </div>

  <script>
    const previewBody = document.getElementById('theme-preview-body');
    const previewCard = document.getElementById('theme-preview-card');
    const previewText = document.getElementById('theme-preview-text');
    const previewMuted = document.getElementById('theme-preview-muted');
    const previewBtn = document.getElementById('theme-preview-btn');
    const previewSuccess = document.getElementById('theme-preview-success');

    const cssVarMap = {
      theme_accent: '--theme-accent',
      theme_accent_2: '--theme-accent-hover',
      theme_success: '--theme-success',
      theme_bg: '--theme-bg',
      theme_card: '--theme-card',
      theme_text: '--theme-text',
      theme_muted: '--theme-muted',
      theme_border: '--theme-border'
    };

    const defaultColors = {
      theme_accent: '#8B5E3C',
      theme_accent_2: '#6D4A30',
      theme_success: '#4A7C59',
      theme_bg: '#F8F5F0',
      theme_card: '#FFFFFF',
      theme_text: '#2D241C',
      theme_muted: '#6B5B4D',
      theme_border: '#E0D6C8'
    };

    function updateLivePreview(key, value) {
      const cssVar = cssVarMap[key];
      if (cssVar) document.documentElement.style.setProperty(cssVar, value);
      if (key === 'theme_bg') previewBody.style.backgroundColor = value;
      if (key === 'theme_card') previewCard.style.backgroundColor = value;
      if (key === 'theme_text') previewText.style.color = value;
      if (key === 'theme_muted') previewMuted.style.color = value;
      if (key === 'theme_accent') previewBtn.style.backgroundColor = value;
      if (key === 'theme_success') {
        previewSuccess.style.color = value;
        previewSuccess.style.borderColor = value;
      }
    }

    function normalize(v) {
      const raw = String(v || '').trim();
      const ok = /^#[0-9a-fA-F]{6}$/.test(raw);
      return ok ? raw.toUpperCase() : null;
    }

    document.querySelectorAll('[data-color-key]').forEach(function(container) {
      const picker = container.querySelector('.color-picker');
      const hex = container.querySelector('.color-hex');
      const key = container.getAttribute('data-color-key');
      if (!picker || !hex || !key) return;

      picker.addEventListener('input', function() {
        const v = normalize(picker.value) || '#000000';
        hex.value = v;
        updateLivePreview(key, v);
      });

      hex.addEventListener('input', function() {
        const v = normalize(hex.value);
        if (!v) return;
        picker.value = v;
        updateLivePreview(key, v);
      });

      hex.addEventListener('blur', function() {
        const v = normalize(hex.value);
        if (!v) {
          const p = normalize(picker.value) || '#000000';
          hex.value = p;
          updateLivePreview(key, p);
          return;
        }
        hex.value = v;
        picker.value = v;
        updateLivePreview(key, v);
      });

      updateLivePreview(key, hex.value);
    });

    const resetColorsBtn = document.getElementById('reset-colors-btn');
    if (resetColorsBtn) {
      resetColorsBtn.addEventListener('click', function() {
        document.querySelectorAll('[data-color-key]').forEach(function(container) {
          const key = container.getAttribute('data-color-key');
          const picker = container.querySelector('.color-picker');
          const hex = container.querySelector('.color-hex');
          const fallback = defaultColors[key];
          if (!key || !picker || !hex || !fallback) return;
          picker.value = fallback;
          hex.value = fallback;
          updateLivePreview(key, fallback);
        });
      });
    }
  </script>
</body>
</html>
