<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Archive Web Offline Tool</title>
  <style>
    :root {
      --bg: {{ app_settings.theme_bg }};
      --panel: {{ app_settings.theme_card }};
      --card: {{ app_settings.theme_card }};
      --text: {{ app_settings.theme_text }};
      --muted: {{ app_settings.theme_muted }};
      --accent: {{ app_settings.theme_accent }};
      --accent-2: {{ app_settings.theme_accent_2 }};
      --success: {{ app_settings.theme_success }};
      --warning: #c9a227;
      --error: #b54242;
      --border: {{ app_settings.theme_border }};
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --radius: 14px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
    }

    /* Layout */
    .app {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: grid;
      place-items: center;
      color: white;
      font-size: 18px;
    }

    .brand h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    .brand p {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    /* Navigation */
    .nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-btn {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
    }

    .nav-btn:hover {
      background: rgba(139, 90, 58, 0.08);
      color: var(--text);
    }

    .nav-btn.active {
      background: rgba(139, 90, 58, 0.12);
      color: var(--accent);
      font-weight: 500;
    }

    .nav-btn .step {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--border);
      color: var(--muted);
      font-size: 11px;
      font-weight: 600;
      display: grid;
      place-items: center;
    }

    .nav-btn.active .step {
      background: var(--accent);
      color: white;
    }

    .nav-btn.completed .step {
      background: var(--success);
      color: white;
    }

    .recent-box {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px;
      background: white;
    }

    .recent-box h4 {
      margin: 0 0 8px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .4px;
    }

    .recent-list {
      display: grid;
      gap: 6px;
      max-height: 170px;
      overflow: auto;
    }

    .recent-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px;
      align-items: stretch;
    }

    .recent-item {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 6px;
      padding: 6px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text);
    }

    .recent-item small {
      display: block;
      color: var(--muted);
      margin-top: 2px;
    }

    .recent-delete {
      border: 1px solid #e6b7b7;
      background: #fff5f5;
      color: #b24545;
      border-radius: 6px;
      padding: 0 10px;
      font-size: 12px;
      cursor: pointer;
      min-width: 36px;
    }

    .recent-delete:hover {
      background: #ffe9e9;
    }

    .sidebar-credit {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px dashed var(--border);
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
    }

    .sidebar-credit a {
      color: var(--muted);
      text-decoration: none;
    }

    .sidebar-credit a:hover {
      text-decoration: underline;
    }


    /* Main Content */
    .main {
      padding: 24px 28px;
      max-width: 1400px;
    }

    /* Workflow Header */
    .workflow-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .workflow-title h2 {
      margin: 0 0 4px;
      font-size: 22px;
    }

    .workflow-title p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .quick-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Cards */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .card-title {
      margin: 0 0 16px;
      font-size: 18px;
      font-weight: 600;
    }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 13px;
      color: var(--text);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      background: white;
      transition: border-color 0.15s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group input[type="checkbox"] {
      width: auto;
      padding: 0;
      margin: 0;
      accent-color: var(--accent);
    }

    .inline-check {
      display: inline-flex;
      align-items: flex-start;
      gap: 8px;
      font-weight: 400;
      color: var(--muted);
      margin-top: 10px;
      cursor: pointer;
    }

    .inline-check span {
      line-height: 1.3;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 18px;
      min-height: 40px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      line-height: 1.1;
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
    }

    a.btn,
    a.btn:visited,
    a.btn:hover,
    a.btn:active {
      text-decoration: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    a.btn-primary,
    a.btn-primary:visited,
    a.btn-primary:hover,
    a.btn-primary:active {
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--accent-2);
    }

    .btn-secondary {
      background: var(--border);
      color: var(--text);
    }

    a.btn-secondary,
    a.btn-secondary:visited,
    a.btn-secondary:hover,
    a.btn-secondary:active {
      color: var(--text);
    }

    .btn-secondary:hover {
      background: #d0c5b8;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    a.btn-success,
    a.btn-success:visited,
    a.btn-success:hover,
    a.btn-success:active {
      color: #fff;
    }

    .btn-success:hover {
      background: #3a6648;
    }

    .btn-quiet {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 8px 12px;
    }

    .btn-quiet:hover {
      background: #f5f1ec;
      border-color: #cfc2b2;
    }

    .btn-support {
      background: #fff7e6;
      color: #7a5a12;
      border: 1px solid #e8d4a2;
    }

    .btn-support:hover {
      background: #ffefcc;
      color: #7a5a12;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .flow-hint {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    .flow-hint.warn {
      color: #9a6f12;
    }

    .continue-card {
      display: none;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: #fff;
      padding: 14px;
    }

    .continue-title {
      margin: 0 0 4px;
      font-size: 14px;
      font-weight: 600;
    }

    .continue-text {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .continue-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Advanced Options Toggle */
    .advanced-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 0;
      cursor: pointer;
      color: var(--muted);
      font-size: 13px;
      border-top: 1px dashed var(--border);
      margin-top: 16px;
    }

    .advanced-toggle:hover {
      color: var(--accent);
    }

    .advanced-content {
      display: none;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      margin-top: 16px;
    }

    .advanced-content.open {
      display: block;
    }

    /* Status Indicators */
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-pill::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-pill.ready {
      background: rgba(139, 90, 58, 0.1);
      color: var(--accent);
    }

    .status-pill.ready::before {
      background: var(--accent);
    }

    .status-pill.running {
      background: rgba(201, 162, 39, 0.1);
      color: var(--warning);
    }

    .status-pill.running::before {
      background: var(--warning);
      animation: pulse 1.5s infinite;
    }

    .status-pill.success {
      background: rgba(74, 124, 89, 0.1);
      color: var(--success);
    }

    .status-pill.success::before {
      background: var(--success);
    }

    .status-pill.error {
      background: rgba(181, 66, 66, 0.1);
      color: var(--error);
    }

    .status-pill.error::before {
      background: var(--error);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Progress Bar */
    .progress-container {
      margin: 16px 0;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .progress-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 4px;
      transition: width 0.3s;
    }

    /* Live Log Panel */
    .log-panel {
      width: 100%;
      margin-top: 22px;
      max-height: none;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .log-header h4 {
      margin: 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .log-badge {
      background: var(--accent);
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .log-actions {
      display: flex;
      gap: 8px;
    }

    .log-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 13px;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
    }

    .log-actions button:hover {
      background: var(--border);
    }

    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.6;
      max-height: 260px;
    }

    .log-entry {
      margin-bottom: 6px;
      color: var(--muted);
    }

    .log-entry.error {
      color: var(--error);
    }

    .log-entry.success {
      color: var(--success);
    }

    .log-entry.warning {
      color: var(--warning);
    }

    /* Timeline */
    .timeline {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 12px 4px;
      margin: 0 -4px;
    }

    .timeline-item {
      flex-shrink: 0;
      padding: 8px 14px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .timeline-item:hover {
      border-color: var(--accent);
      background: rgba(139, 90, 58, 0.05);
    }

    .timeline-item.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    /* Preview iframe */
    .preview-container {
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: white;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #f5f2ed;
      border-bottom: 1px solid var(--border);
    }

    .preview-frame {
      width: 100%;
      height: 400px;
      border: none;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin: 16px 0;
    }

    .stat-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
    }

    /* Action Buttons */
    .action-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 12px;
    }

    .list-box {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
      padding: 10px;
    }

    .list-box h5 {
      margin: 0 0 8px;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px;
    }

    .list-box ul {
      margin: 0;
      padding-left: 18px;
      max-height: 180px;
      overflow: auto;
      font-size: 13px;
    }

    .mono-list {
      font-family: Consolas, Monaco, monospace;
      font-size: 12px;
      line-height: 1.45;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Error/Success Messages */
    .alert {
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-error {
      background: rgba(181, 66, 66, 0.1);
      border: 1px solid rgba(181, 66, 66, 0.2);
      color: var(--error);
    }

    .alert-success {
      background: rgba(74, 124, 89, 0.1);
      border: 1px solid rgba(74, 124, 89, 0.2);
      color: var(--success);
    }

    .cache-note {
      margin: 10px 0 4px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .cache-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 3px 10px;
      background: #fff;
      font-size: 11px;
      color: var(--muted);
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }

    .status-line {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .snap-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      margin: 0 6px 6px 0;
      background: #fff;
      cursor: pointer;
    }

    .snap-chip:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .step-overlay {
      position: fixed;
      inset: 0;
      background: rgba(248, 245, 240, 0.86);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 120;
    }

    .step-overlay.show {
      display: flex;
    }

    .confirm-modal {
      position: fixed;
      inset: 0;
      background: rgba(10, 8, 6, 0.45);
      z-index: 1200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .confirm-modal.show {
      display: flex;
    }

    .confirm-card {
      width: min(460px, calc(100vw - 24px));
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .confirm-title {
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 600;
    }

    .confirm-text {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-line;
    }

    .confirm-check {
      margin-top: 12px;
      display: inline-flex;
      align-items: flex-start;
      gap: 8px;
      color: var(--text);
      font-size: 14px;
    }

    .confirm-actions {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .step-overlay-card {
      width: min(560px, calc(100vw - 32px));
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .step-overlay-head {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .spin {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .step-list {
      margin: 8px 0 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 13px;
    }

    .step-list li.active {
      color: var(--accent);
      font-weight: 600;
    }

    /* Hidden sections */
    .section-hidden {
      display: none;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        position: relative;
        height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      
      .nav {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .workflow-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .quick-actions {
        width: 100%;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }

      .preview-frame {
        height: 340px;
      }
      
      .log-panel { width: 100%; }
    }

    @media (max-width: 640px) {
      .main {
        padding: 14px 12px;
      }

      .card {
        padding: 14px;
        margin-bottom: 14px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .nav {
        flex-wrap: nowrap;
        overflow-x: auto;
      }

      .nav-btn {
        flex: 0 0 auto;
      }

      .action-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .action-bar form,
      .action-bar button,
      .action-bar .btn {
        width: 100%;
      }

      .preview-frame {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <datalist id="output-root-options">
    {% for p in output_choices %}
    <option value="{{ p }}">
    {% endfor %}
  </datalist>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-icon">üì¶</div>
        <div>
          <h1>Archive Tool</h1>
          <p>Wayback offline builder</p>
        </div>
      </div>

      <nav class="nav">
        <button type="button" class="nav-btn active" data-step="1" data-go-tab="inspect">
          <span class="step">1</span>
          <span>Inspect</span>
        </button>
        <button type="button" class="nav-btn" data-step="2" data-go-tab="analyze">
          <span class="step">2</span>
          <span>Analyze</span>
        </button>
        <button type="button" class="nav-btn" data-step="3" data-go-tab="sitemap">
          <span class="step">3</span>
          <span>Sitemap</span>
        </button>
        <button type="button" class="nav-btn" data-step="4" data-go-tab="check">
          <span class="step">4</span>
          <span>Check</span>
        </button>
        <button type="button" class="nav-btn" data-step="5" data-go-tab="download">
          <span class="step">5</span>
          <span>Download</span>
        </button>
      </nav>

      <div class="recent-box">
        <h4>Recent Projects</h4>
        <div class="recent-list">
          {% for p in recent_projects %}
          <div class="recent-row" data-project-row="{{ p.target_url }}">
            <button type="button" class="recent-item" data-recent-url="{{ p.target_url }}" data-recent-output="{{ p.last_output_root or output_root }}">
              {{ p.domain }}
              <small>{{ p.last_snapshot or '-' }} | {{ p.last_site_type or 'Unknown' }}</small>
            </button>
            <button type="button" class="recent-delete" data-delete-project-url="{{ p.target_url }}" title="Remove this project">‚úï</button>
          </div>
          {% endfor %}
          {% if not recent_projects %}
          <div class="recent-item" style="cursor:default;opacity:.7;">No saved projects yet</div>
          {% endif %}
        </div>
      </div>

      <div style="margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border);">
        <div class="status-pill ready" id="status-indicator">
          Ready
        </div>
        <div style="margin-top:10px;">
          <a href="/settings" style="font-size:12px;color:var(--muted);">Settings</a>
          <span style="color:var(--border);margin:0 6px;">|</span>
          <a href="/diagnostics" target="_blank" style="font-size:12px;color:var(--muted);">Open diagnostics</a>
        </div>
        <div class="sidebar-credit">
          <div>Designed by <a href="https://vjranga.com" target="_blank" rel="noopener">vjranga.com</a></div>
          <div>Copyright &copy; 2026 VJ Wayback Offline Builder. All rights reserved.</div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Header -->
      <div class="workflow-header">
        <div class="workflow-title">
          <h2>Step 1: Inspect Archive</h2>
          <p>Find and explore available snapshots for your website</p>
        </div>
        <div class="quick-actions">
          <a href="https://buymeacoffee.com/vjranga" target="_blank" rel="noopener" class="btn btn-support">‚òï Support this project</a>
          <a href="/" class="btn btn-primary">‚ûï New Project</a>
          <button type="button" class="btn btn-success" id="quick-download-btn" style="display:none;">
            ‚ö° Quick Download
          </button>
        </div>
      </div>

      <div id="continue-card" class="continue-card">
        <p class="continue-title" id="continue-title">Continue where you left off</p>
        <p class="continue-text" id="continue-text"></p>
        <div class="continue-actions">
          <button type="button" class="btn btn-primary" id="continue-action-btn">Open Next Step</button>
        </div>
      </div>

      <!-- Input Card -->
      <div class="card">
        <h3 class="card-title">Website URL</h3>
        
        <form id="inspect-form" method="post" action="/inspect">
          <div class="form-group">
            <label for="target-url">Enter website URL to archive</label>
            <input type="url" id="target-url" name="target_url" placeholder="https://example.com" 
                   value="{{ target_url }}" required pattern="https?://.+" 
                   title="Enter a valid URL starting with http:// or https://">
            <label class="inline-check">
              <input type="checkbox" name="force_refresh" value="1">
              <span>Refresh from Archive (ignore local cache)</span>
            </label>
            <label class="inline-check">
              <input type="checkbox" id="advanced-mode-toggle" name="advanced_mode" value="1">
              <span>Advanced mode (manual limits)</span>
            </label>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="output-root">Output folder</label>
              <input type="text" id="output-root" name="output_root" list="output-root-options"
                     value="{{ output_root }}" placeholder="Auto-generated from URL">
              <div style="margin-top:8px;">
                <button type="button" class="btn btn-secondary" id="pick-folder-btn" style="padding:6px 10px;font-size:12px;">üìÅ Pick Folder</button>
              </div>
              <div style="margin-top:6px;color:var(--muted);font-size:12px;">
                Browser picker can only return folder name. Use manual path input for full absolute path.
              </div>
            </div>
            <div class="form-group" id="inspect-advanced-panel" style="display:none;">
              <label for="scan-mode">Inspect mode</label>
              <select id="scan-mode">
                <option value="quick">Quick (fast)</option>
                <option value="balanced" selected>Balanced</option>
                <option value="deep">Deep (slow)</option>
              </select>
            </div>
          </div>

          <input type="hidden" id="display-limit-input" name="display_limit" value="{{ app_settings.default_display_limit }}">
          <input type="hidden" id="cdx-limit-input" name="cdx_limit" value="{{ app_settings.default_inspect_cdx_limit }}">

          <div class="form-row">
            <div class="form-group">
              <label>&nbsp;</label>
              <button type="submit" class="btn btn-primary" style="width: 100%;">
                üîç Find Snapshots
              </button>
            </div>
          </div>

        </form>

        <div id="inspect-live" class="progress-container" style="display:none;">
          <div class="progress-info">
            <span id="inspect-live-text">Checking snapshots...</span>
            <strong id="inspect-live-percent">0%</strong>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="inspect-live-bar" style="width:0%"></div>
          </div>
          <p id="inspect-live-detail" style="margin:8px 0 0;color:var(--muted);font-size:13px;"></p>
          <div class="action-bar" style="margin-top:10px;padding-top:10px;">
            <button type="button" class="btn btn-secondary" id="inspect-pause-btn" disabled>Pause</button>
            <button type="button" class="btn btn-secondary" id="inspect-resume-btn" disabled>Resume</button>
            <button type="button" class="btn btn-secondary" id="inspect-stop-btn" disabled>Stop</button>
          </div>
        </div>
      </div>

      <div class="card" id="project-data-card" style="display:none;">
        <h3 class="card-title">üìå Local Project Data</h3>
        <p class="status-line" id="project-data-summary"></p>
        <div class="status-grid" style="margin-top:10px;">
          <div class="list-box">
            <h5>Inspect Cache</h5>
            <ul class="mono-list" id="project-inspect-list"></ul>
          </div>
          <div class="list-box">
            <h5>Analyze Snapshots</h5>
            <div id="project-analyze-list"></div>
          </div>
          <div class="list-box">
            <h5>Sitemap Snapshots</h5>
            <div id="project-sitemap-list"></div>
          </div>
          <div class="list-box">
            <h5>Check Snapshots</h5>
            <div id="project-check-list"></div>
          </div>
        </div>
      </div>

      <div class="card" id="recent-projects-main">
        <h3 class="card-title">üóÇÔ∏è Recent Activity</h3>
        <div class="detail-grid">
          <div class="list-box">
            <h5>Projects</h5>
            <ul class="mono-list">
              {% for p in recent_projects %}
              <li data-project-row="{{ p.target_url }}">
                <div class="recent-row">
                  <button type="button" class="recent-item" style="width:100%;text-align:left;" data-recent-url="{{ p.target_url }}" data-recent-output="{{ p.last_output_root or output_root }}">
                    {{ p.target_url }}
                    <small>{{ p.last_snapshot or '-' }} | {{ p.last_site_type or 'Unknown' }}</small>
                  </button>
                  <button type="button" class="recent-delete" data-delete-project-url="{{ p.target_url }}" title="Remove this project">‚úï</button>
                </div>
              </li>
              {% endfor %}
              {% if not recent_projects %}<li>No projects yet</li>{% endif %}
            </ul>
          </div>
          <div class="list-box">
            <h5>Latest Jobs</h5>
            <ul class="mono-list">
              {% for j in recent_jobs %}
              <li>
                <strong>{{ j.job_type }}</strong> | {{ j.state }} | {{ j.created_local }}
                <div style="color:var(--muted);">{{ j.target_url }}</div>
              </li>
              {% endfor %}
              {% if not recent_jobs %}<li>No jobs yet</li>{% endif %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Error Messages -->
      {% if error %}
      <div class="alert alert-error">
        <span>‚ö†Ô∏è</span>
        <span>{{ error }}</span>
      </div>
      {% endif %}

      {% if action_message %}
      <div class="alert alert-success">
        <span>‚úì</span>
        <span>{{ action_message }}</span>
      </div>
      {% endif %}

      <!-- Results Section -->
      {% if inspect %}
      <div class="card" id="inspect-results">
        <h3 class="card-title">üìä Snapshot Overview</h3>
        {% if inspect._cache %}
        <div class="cache-note">
          <span class="cache-badge">Source: {{ inspect._cache.source }}</span>
          <span class="cache-badge">Age: {{ inspect._cache.age_seconds }}s</span>
        </div>
        {% endif %}
        {% if inspect._fallback_notice %}
        <div class="alert" style="background: rgba(201,162,39,0.12); border:1px solid rgba(201,162,39,0.25); color:#7a6015; margin-top:8px;">
          <span>‚ö†Ô∏è</span>
          <div>{{ inspect._fallback_notice }}</div>
        </div>
        {% endif %}
        {% if inspect.fallback_used %}
        <div class="alert" style="background: rgba(201,162,39,0.12); border:1px solid rgba(201,162,39,0.25); color:#7a6015; margin-top:8px;">
          <span>‚ö†Ô∏è</span>
          <span>Quick fallback mode used due Wayback slowness. You can click "Load More Snapshots" for deeper results.</span>
        </div>
        {% endif %}
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">{{ inspect.total_snapshots }}</div>
            <div class="stat-label">Total Captures</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ inspect.total_ok_snapshots }}</div>
            <div class="stat-label">Available (200)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ inspect.snapshots|length }}</div>
            <div class="stat-label">Showing</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ inspect.latest_snapshot[:4] }}</div>
            <div class="stat-label">Latest Year</div>
          </div>
        </div>

        <h4 style="margin: 20px 0 12px;">üìÖ Recent Timeline (quick pick)</h4>
        <div class="timeline">
          {% for ts in inspect.snapshots[:30] %}
            <button type="button" data-ts="{{ ts }}" class="timeline-item snapshot-chip {% if ts == (selected_snapshot or inspect.latest_ok_snapshot or inspect.latest_snapshot) %}active{% endif %}" title="{{ ts }}">
              {{ ts[0:4] }}-{{ ts[4:6] }}-{{ ts[6:8] }}
            </button>
          {% endfor %}
        </div>

        <h4 style="margin: 20px 0 12px;">üéØ Confirm Snapshot</h4>
        <form method="post" action="/analyze" id="analyze-form" class="form-row">
          <input type="hidden" name="target_url" value="{{ inspect.target_url }}">
          <input type="hidden" name="output_root" value="{{ output_root }}">
          <input type="hidden" name="display_limit" value="{{ inspect.display_limit or 10 }}">
          <div class="form-group">
            <label>Snapshot time</label>
            <select name="selected_snapshot" id="selected-snapshot">
              {% for ts in inspect.snapshots %}
              <option value="{{ ts }}" {% if ts == (selected_snapshot or inspect.latest_ok_snapshot or inspect.latest_snapshot) %}selected{% endif %}>{{ ts }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <input type="hidden" name="cdx_limit" value="{{ app_settings.default_analyze_cdx_limit }}">
            <div id="analyze-advanced-panel" style="display:none;">
              <label>Analysis mode</label>
              <select name="cdx_limit" id="analyze-depth">
                <option value="1500">Quick</option>
                <option value="5000">Balanced</option>
                <option value="12000" selected>Deep</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button id="analyze-submit-btn" type="submit" class="btn btn-primary" style="width:100%;">Analyze Selected Snapshot</button>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button type="button" class="btn btn-secondary" id="open-cached-snapshot-btn" style="width:100%;">Load Saved Data For Snapshot</button>
          </div>
        </form>
        <p id="analyze-flow-hint" class="flow-hint">Pick a snapshot, then run analysis.</p>

        <div id="analyze-live" class="progress-container" style="display:none;">
          <div class="progress-info"><span id="analyze-live-text">Analyzing...</span><strong id="analyze-live-percent">0%</strong></div>
          <div class="progress-bar"><div class="progress-fill" id="analyze-live-bar" style="width:0%"></div></div>
          <p id="analyze-live-detail" style="margin:8px 0 0;color:var(--muted);font-size:13px;"></p>
          <div class="action-bar" style="margin-top:10px;padding-top:10px;">
            <button type="button" class="btn btn-secondary" id="analyze-pause-btn" disabled>Pause</button>
            <button type="button" class="btn btn-secondary" id="analyze-resume-btn" disabled>Resume</button>
            <button type="button" class="btn btn-secondary" id="analyze-stop-btn" disabled>Stop</button>
          </div>
        </div>

        <h4 style="margin: 16px 0 10px;">üß™ Analyze Multiple Snapshots (one-by-one)</h4>
        <form id="analyze-batch-form" class="form-row">
          <input type="hidden" name="target_url" value="{{ inspect.target_url }}">
          <input type="hidden" name="output_root" value="{{ output_root }}">
          <input type="hidden" name="display_limit" value="{{ inspect.display_limit or 10 }}">
          <input type="hidden" name="inspect_cdx_limit" value="{{ inspect.cdx_limit or 1500 }}">
          <input type="hidden" name="analyze_count" id="analyze-count-input" value="100000">
          <input type="hidden" name="analyze_cdx_limit" id="analyze-cdx-input" value="{{ app_settings.default_analyze_cdx_limit }}">
          <div class="form-group" style="grid-column: span 2;">
            <div id="batch-advanced-panel" style="display:none;">
              <label>Batch analysis options</label>
              <div class="form-row">
                <div class="form-group">
                  <label>How many snapshots</label>
                  <input type="number" id="analyze-count-advanced" min="1" max="100000" value="100000">
                </div>
                <div class="form-group">
                  <label>Detail mode per snapshot</label>
                  <select id="analyze-cdx-advanced">
                    <option value="1500">Quick</option>
                    <option value="5000">Balanced</option>
                    <option value="12000" selected>Deep</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button id="batch-submit-btn" type="submit" class="btn btn-secondary" style="width:100%;">Run Deep Step-by-Step Analysis</button>
          </div>
        </form>

        <div id="analyze-batch-live" class="progress-container" style="display:none;">
          <div class="progress-info"><span id="analyze-batch-text">Analyzing snapshots one-by-one...</span><strong id="analyze-batch-percent">0%</strong></div>
          <div class="progress-bar"><div class="progress-fill" id="analyze-batch-bar" style="width:0%"></div></div>
          <p id="analyze-batch-detail" style="margin:8px 0 0;color:var(--muted);font-size:13px;"></p>
          <div class="action-bar" style="margin-top:10px;padding-top:10px;">
            <button type="button" class="btn btn-secondary" id="analyze-batch-pause-btn" disabled>Pause</button>
            <button type="button" class="btn btn-secondary" id="analyze-batch-resume-btn" disabled>Resume</button>
            <button type="button" class="btn btn-secondary" id="analyze-batch-stop-btn" disabled>Stop</button>
          </div>
        </div>

        <h4 style="margin: 20px 0 12px;">üëÅÔ∏è Latest Capture Preview</h4>
        <div class="preview-container">
          <div class="preview-header">
            <span>Archive.org Preview</span>
            <a id="preview-link" href="https://web.archive.org/web/{{ selected_snapshot or inspect.latest_ok_snapshot or inspect.latest_snapshot }}/{{ inspect.target_url }}"
               target="_blank" style="color: var(--accent); font-size: 13px;">Open in new tab ‚Üí</a>
          </div>
          <iframe class="preview-frame" id="preview-frame"
                  src="https://web.archive.org/web/{{ selected_snapshot or inspect.latest_ok_snapshot or inspect.latest_snapshot }}/{{ inspect.target_url }}"
                  loading="lazy"></iframe>
        </div>

        <div class="action-bar">
          <form method="post" action="/inspect">
            <input type="hidden" name="target_url" value="{{ inspect.target_url }}">
            <input type="hidden" name="output_root" value="{{ output_root }}">
            <input type="hidden" name="display_limit" value="{{ (inspect.display_limit or 10) + 10 }}">
            <input type="hidden" name="cdx_limit" value="{{ (inspect.cdx_limit or 1500) + 1500 }}">
            <button type="submit" class="btn btn-secondary">
              Load More Snapshots
            </button>
          </form>
        </div>
      </div>
      {% endif %}

      {% if analysis %}
      <div class="card" id="analyze-results">
        <h3 class="card-title">üß† Analysis Details</h3>
        {% if analysis._cache %}
        <div class="cache-note">
          <span class="cache-badge">Source: {{ analysis._cache.source }}</span>
          <span class="cache-badge">Age: {{ analysis._cache.age_seconds }}s</span>
        </div>
        {% endif %}
        {% if analysis._fallback_notice %}
        <div class="alert" style="background: rgba(201,162,39,0.12); border:1px solid rgba(201,162,39,0.25); color:#7a6015; margin-top:8px;">
          <span>‚ö†Ô∏è</span>
          <div>{{ analysis._fallback_notice }}</div>
        </div>
        {% endif %}
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">{{ analysis.selected_snapshot[:8] }}</div>
            <div class="stat-label">Selected Date</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ analysis.estimated_files }}</div>
            <div class="stat-label">Estimated Files</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ analysis.estimated_size_human }}</div>
            <div class="stat-label">Estimated Size</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ analysis.site_type }}</div>
            <div class="stat-label">Detected Type</div>
          </div>
        </div>

        <div class="action-bar" id="download-results">
          <form method="post" action="/download" id="download-form-simple" class="form-row" style="width:100%;">
            <input type="hidden" name="target_url" value="{{ analysis.target_url }}">
            <input type="hidden" name="selected_snapshot" value="{{ analysis.selected_snapshot }}">
            <input type="hidden" name="output_root" value="{{ output_root }}">
            <div class="form-group">
              <label>Max files (default safe)</label>
              <input type="number" name="max_files" min="50" max="5000" value="{{ app_settings.default_max_files }}">
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button id="download-submit-btn" type="submit" class="btn btn-success" style="width:100%;">Download Offline Copy</button>
            </div>
          </form>
        </div>
        <p id="download-flow-hint" class="flow-hint">Run download to build your local offline copy.</p>

        <div id="download-live" class="progress-container" style="display:none;">
          <div class="progress-info">
            <span id="download-live-text">Preparing download...</span>
            <strong id="download-live-percent">0%</strong>
          </div>
          <div class="progress-bar"><div class="progress-fill" id="download-live-bar" style="width:0%"></div></div>
          <p id="download-live-detail" style="margin:8px 0 0;color:var(--muted);font-size:13px;"></p>
          <div class="action-bar" style="margin-top:10px;padding-top:10px;">
            <button type="button" class="btn btn-secondary" id="download-pause-btn" disabled>Pause</button>
            <button type="button" class="btn btn-secondary" id="download-resume-btn" disabled>Resume</button>
            <button type="button" class="btn btn-secondary" id="download-stop-btn" disabled>Stop</button>
          </div>
        </div>

        <div class="action-bar" style="margin-top:14px;">
          <form method="post" action="/sitemap" id="sitemap-form">
            <input type="hidden" name="target_url" value="{{ analysis.target_url }}">
            <input type="hidden" name="selected_snapshot" value="{{ analysis.selected_snapshot }}">
            <input type="hidden" name="output_root" value="{{ output_root }}">
            <input type="hidden" name="cdx_limit" value="{{ app_settings.default_inspect_cdx_limit }}">
            <button id="sitemap-submit-btn" type="submit" class="btn btn-secondary">Show Sitemap Details</button>
          </form>
          <form method="post" action="/check" id="check-form">
            <input type="hidden" name="target_url" value="{{ analysis.target_url }}">
            <input type="hidden" name="selected_snapshot" value="{{ analysis.selected_snapshot }}">
            <input type="hidden" name="output_root" value="{{ output_root }}">
            <button id="check-submit-btn" type="submit" class="btn btn-secondary">Check Downloaded Files</button>
          </form>
        </div>
        <p id="check-manifest-hint" class="status-line" style="margin-top:8px;">Tip: First click Download Offline Copy. After files are downloaded, use Check Downloaded Files.</p>

        <div id="sitemap-live" class="progress-container" style="display:none;">
          <div class="progress-info"><span id="sitemap-live-text">Building sitemap...</span><strong id="sitemap-live-percent">0%</strong></div>
          <div class="progress-bar"><div class="progress-fill" id="sitemap-live-bar" style="width:0%"></div></div>
          <p id="sitemap-live-detail" style="margin:8px 0 0;color:var(--muted);font-size:13px;"></p>
          <div class="action-bar" style="margin-top:10px;padding-top:10px;">
            <button type="button" class="btn btn-secondary" id="sitemap-pause-btn" disabled>Pause</button>
            <button type="button" class="btn btn-secondary" id="sitemap-resume-btn" disabled>Resume</button>
            <button type="button" class="btn btn-secondary" id="sitemap-stop-btn" disabled>Stop</button>
          </div>
        </div>

        <div id="check-live" class="progress-container" style="display:none;">
          <div class="progress-info"><span id="check-live-text">Checking files...</span><strong id="check-live-percent">0%</strong></div>
          <div class="progress-bar"><div class="progress-fill" id="check-live-bar" style="width:0%"></div></div>
          <p id="check-live-detail" style="margin:8px 0 0;color:var(--muted);font-size:13px;"></p>
          <div class="action-bar" style="margin-top:10px;padding-top:10px;">
            <button type="button" class="btn btn-secondary" id="check-pause-btn" disabled>Pause</button>
            <button type="button" class="btn btn-secondary" id="check-resume-btn" disabled>Resume</button>
            <button type="button" class="btn btn-secondary" id="check-stop-btn" disabled>Stop</button>
          </div>
        </div>

        {% if analysis.wordpress and analysis.wordpress.detected %}
        <h4 style="margin:18px 0 10px;">WordPress Detection</h4>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">{{ analysis.wordpress.themes|length }}</div><div class="stat-label">Themes</div></div>
          <div class="stat-card"><div class="stat-value">{{ analysis.wordpress.plugins|length }}</div><div class="stat-label">Plugins</div></div>
          <div class="stat-card"><div class="stat-value">{{ analysis.wordpress.categories|length }}</div><div class="stat-label">Categories</div></div>
          <div class="stat-card"><div class="stat-value">{{ analysis.wordpress.tags|length }}</div><div class="stat-label">Tags</div></div>
        </div>

        <div class="detail-grid">
          <div class="list-box">
            <h5>Themes</h5>
            <ul>
              {% for x in analysis.wordpress.themes %}<li>{{ x }}</li>{% endfor %}
              {% if not analysis.wordpress.themes %}<li>None detected</li>{% endif %}
            </ul>
          </div>
          <div class="list-box">
            <h5>Plugins</h5>
            <ul>
              {% for x in analysis.wordpress.plugins %}<li>{{ x }}</li>{% endfor %}
              {% if not analysis.wordpress.plugins %}<li>None detected</li>{% endif %}
            </ul>
          </div>
          <div class="list-box">
            <h5>Categories</h5>
            <ul>
              {% for x in analysis.wordpress.categories %}<li>{{ x }}</li>{% endfor %}
              {% if not analysis.wordpress.categories %}<li>None detected</li>{% endif %}
            </ul>
          </div>
          <div class="list-box">
            <h5>Tags</h5>
            <ul>
              {% for x in analysis.wordpress.tags %}<li>{{ x }}</li>{% endfor %}
              {% if not analysis.wordpress.tags %}<li>None detected</li>{% endif %}
            </ul>
          </div>
        </div>

        <div class="detail-grid">
          <div class="list-box">
            <h5>Post Types</h5>
            <ul>
              {% for x in analysis.wordpress.post_types %}<li>{{ x }}</li>{% endfor %}
              {% if not analysis.wordpress.post_types %}<li>None detected</li>{% endif %}
            </ul>
          </div>
          <div class="list-box">
            <h5>Blog URLs (sample)</h5>
            <ul class="mono-list">
              {% for x in analysis.wordpress.blog_posts %}<li>{{ x }}</li>{% endfor %}
              {% if not analysis.wordpress.blog_posts %}<li>None detected</li>{% endif %}
            </ul>
          </div>
          <div class="list-box" style="grid-column: 1 / -1;">
            <h5>WP JSON Routes (sample)</h5>
            <ul class="mono-list">
              {% for x in analysis.wordpress.wp_json_routes %}<li>{{ x }}</li>{% endfor %}
              {% if not analysis.wordpress.wp_json_routes %}<li>None detected</li>{% endif %}
            </ul>
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}

      {% if sitemap %}
      <div class="card" id="sitemap-results">
        <h3 class="card-title">üó∫Ô∏è Sitemap View</h3>
        {% if sitemap._cache %}
        <div class="cache-note">
          <span class="cache-badge">Source: {{ sitemap._cache.source }}</span>
          <span class="cache-badge">Age: {{ sitemap._cache.age_seconds }}s</span>
          {% if selected_snapshot %}<span class="cache-badge">Snapshot: {{ selected_snapshot }}</span>{% endif %}
        </div>
        {% endif %}
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">{{ sitemap.total_pages }}</div><div class="stat-label">Pages</div></div>
          <div class="stat-card"><div class="stat-value">{{ sitemap.groups|length }}</div><div class="stat-label">Folder groups</div></div>
          <div class="stat-card"><div class="stat-value">{{ (sitemap.top_folders or [])|length }}</div><div class="stat-label">Top folders</div></div>
          <div class="stat-card"><div class="stat-value">{{ (sitemap.pages or [])|length }}</div><div class="stat-label">Known URLs</div></div>
        </div>

        <div class="action-bar" style="margin-top:10px;">
          <form method="post" action="/sitemap/export/json">
            <input type="hidden" name="target_url" value="{{ target_url }}">
            <input type="hidden" name="selected_snapshot" value="{{ selected_snapshot }}">
            <button type="submit" class="btn btn-secondary">Export JSON</button>
          </form>
          <form method="post" action="/sitemap/export/csv">
            <input type="hidden" name="target_url" value="{{ target_url }}">
            <input type="hidden" name="selected_snapshot" value="{{ selected_snapshot }}">
            <button type="submit" class="btn btn-secondary">Export CSV</button>
          </form>
        </div>

        <div class="detail-grid">
          <div class="list-box">
            <h5>Top Folders</h5>
            <ul class="mono-list">
              {% for item in sitemap.top_folders %}<li>{{ item[0] }} ({{ item[1] }})</li>{% endfor %}
              {% if not sitemap.top_folders %}<li>No folder data</li>{% endif %}
            </ul>
          </div>
          <div class="list-box">
            <h5>Pages (sample)</h5>
            <ul class="mono-list">
              {% for p in sitemap.pages[:200] %}<li>{{ p }}</li>{% endfor %}
              {% if not sitemap.pages %}<li>No pages</li>{% endif %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}

      {% if check %}
      <div class="card" id="check-results">
        <h3 class="card-title">üß© Downloaded vs Missing Files</h3>
        {% if check._cache %}
        <div class="cache-note">
          <span class="cache-badge">Source: {{ check._cache.source }}</span>
          <span class="cache-badge">Age: {{ check._cache.age_seconds }}s</span>
          {% if check.snapshot %}<span class="cache-badge">Snapshot: {{ check.snapshot }}</span>{% endif %}
        </div>
        {% endif %}
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">{{ check.have_count }}</div><div class="stat-label">Matched</div></div>
          <div class="stat-card"><div class="stat-value">{{ check.missing_count }}</div><div class="stat-label">Missing</div></div>
          <div class="stat-card"><div class="stat-value">{{ check.coverage_percent }}%</div><div class="stat-label">Coverage</div></div>
          <div class="stat-card"><div class="stat-value">{{ check.downloaded_size_human }}</div><div class="stat-label">Downloaded size</div></div>
        </div>
        <form method="post" action="/download-missing" id="missing-form" class="form-row" style="margin-top:10px;">
          <input type="hidden" name="target_url" value="{{ check.target_url }}">
          <input type="hidden" name="selected_snapshot" value="{{ check.snapshot }}">
          <input type="hidden" name="output_root" value="{{ output_root }}">
          <div class="form-group">
            <label>Missing files to try</label>
              <input type="number" name="missing_limit" min="1" max="5000" value="{{ app_settings.default_missing_limit }}">
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button id="missing-submit-btn" type="submit" class="btn btn-secondary" style="width:100%;">Recover Missing Files</button>
          </div>
        </form>
        <p id="missing-flow-hint" class="flow-hint">Use this after a check result shows missing files.</p>

        <div class="detail-grid">
          <div class="list-box">
            <h5>Missing URLs (sample)</h5>
            <ul class="mono-list">
              {% for u in check.missing_urls %}<li>{{ u }}</li>{% endfor %}
              {% if not check.missing_urls %}<li>No missing URLs</li>{% endif %}
            </ul>
          </div>
          <div class="list-box">
            <h5>Matched URLs (sample)</h5>
            <ul class="mono-list">
              {% for u in check.have_urls %}<li>{{ u }}</li>{% endfor %}
              {% if not check.have_urls %}<li>No matched URLs listed</li>{% endif %}
            </ul>
          </div>
        </div>

        <div id="missing-live" class="progress-container" style="display:none;">
          <div class="progress-info">
            <span id="missing-live-text">Preparing missing download...</span>
            <strong id="missing-live-percent">0%</strong>
          </div>
          <div class="progress-bar"><div class="progress-fill" id="missing-live-bar" style="width:0%"></div></div>
          <p id="missing-live-detail" style="margin:8px 0 0;color:var(--muted);font-size:13px;"></p>
          <div class="action-bar" style="margin-top:10px;padding-top:10px;">
            <button type="button" class="btn btn-secondary" id="missing-pause-btn" disabled>Pause</button>
            <button type="button" class="btn btn-secondary" id="missing-resume-btn" disabled>Resume</button>
            <button type="button" class="btn btn-secondary" id="missing-stop-btn" disabled>Stop</button>
          </div>
        </div>
      </div>
      {% endif %}

      {% if result %}
      <div class="card" id="download-finished">
        <h3 class="card-title">‚úÖ Download Result</h3>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-value">{{ result.files_downloaded }}</div><div class="stat-label">Downloaded</div></div>
          <div class="stat-card"><div class="stat-value">{{ result.files_recovered }}</div><div class="stat-label">Recovered</div></div>
          <div class="stat-card"><div class="stat-value">{{ result.coverage_percent }}%</div><div class="stat-label">Coverage</div></div>
          <div class="stat-card"><div class="stat-value">{{ result.seconds }}s</div><div class="stat-label">Duration</div></div>
        </div>
      </div>
      {% endif %}

      <div class="log-panel" id="log-panel">
        <div class="log-header">
          <h4>
            üìã Activity Log
            <span class="log-badge" id="log-count">0</span>
          </h4>
          <div class="log-actions">
            <button type="button" onclick="clearLog()" title="Clear">üóëÔ∏è</button>
          </div>
        </div>
        <div class="log-content" id="log-content">
          <div class="log-entry">Ready to start. Enter a URL and click "Find Snapshots"</div>
        </div>
      </div>
    </main>
  </div>

  <div class="step-overlay" id="step-overlay" aria-hidden="true">
    <div class="step-overlay-card">
      <div class="step-overlay-head">
        <div class="spin"></div>
        <strong id="step-overlay-title">Working...</strong>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="step-overlay-bar" style="width: 8%"></div></div>
      <p id="step-overlay-detail" style="margin:8px 0 0;color:var(--muted);font-size:13px;">Please wait...</p>
      <ul class="step-list" id="step-overlay-list"></ul>
    </div>
  </div>

  <div id="confirm-modal" class="confirm-modal" aria-hidden="true">
    <div class="confirm-card" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
      <h4 id="confirm-title" class="confirm-title">Confirm action</h4>
      <p id="confirm-text" class="confirm-text"></p>
      <label id="confirm-check-wrap" class="confirm-check" style="display:none;">
        <input id="confirm-check" type="checkbox">
        <span id="confirm-check-label">Also delete output files</span>
      </label>
      <div class="confirm-actions">
        <button type="button" class="btn btn-secondary" id="confirm-cancel-btn">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirm-ok-btn">Delete</button>
      </div>
    </div>
  </div>

  <script>
    window.WOB_CONTEXT = {
      csrfToken: {{ csrf_token|tojson }},
      targetUrl: {{ (target_url or '')|tojson }},
      hasInspect: {% if inspect %}true{% else %}false{% endif %},
      hasAnalysis: {% if analysis %}true{% else %}false{% endif %},
      hasSitemap: {% if sitemap %}true{% else %}false{% endif %},
      hasCheck: {% if check %}true{% else %}false{% endif %},
      hasResult: {% if result %}true{% else %}false{% endif %},
      inspectTotal: {% if inspect %}{{ inspect.total_snapshots }}{% else %}0{% endif %},
      analysisSnapshot: {{ (analysis.selected_snapshot if analysis else '')|tojson }},
      resultFiles: {% if result %}{{ result.files_downloaded }}{% else %}0{% endif %},
      checkMissing: {% if check %}{{ check.missing_count }}{% else %}0{% endif %}
    };
  </script>
  <script src="{{ url_for('static', filename='js/core.js') }}"></script>
  <script src="{{ url_for('static', filename='js/jobs.js') }}"></script>
</body>
</html>
